<%@ page contentType="text/html;charset=UTF-8" language="java" %><%@ page import="java.util.*" %><%@ page import="dao.Cart_Use" %><%@ page import="dao.Cart" %><%@ page import="java.sql.SQLException" %><%@ page import="dao.Goodlist" %><%@ page import="dao.Goodlist_Use" %><%    // 检查用户是否已登录    if (session.getAttribute("upname") == null) {        response.sendRedirect("login.jsp"); // 如果未登录，重定向到登录页面        return; // 结束当前页面的执行    }%><html><head>    <title>购物车界面</title>    <link href="css/main.css" rel="stylesheet">    <link href="css/Gwc.css" rel="stylesheet">    <script src="js/jquery-3.4.1.min.js"></script>    <script>        function deleteItem(itemId) {            $.post("cartAction", { action: "delete", id: itemId }, function(response) {                if (response === "success") {                    alert("商品已删除");                    window.location.reload(); // 刷新当前页面                } else {                    alert("删除失败，请重试");                }            });        }        function clearCart() {            if (confirm("您确定要清空购物车吗？")) {                $.post("cartAction", { action: "clear" }, function(response) {                    if (response === "success") {                        alert("购物车已清空");                        window.location.reload(); // 刷新当前页面                    } else {                        alert("清空购物车失败，请重试");                    }                });            }        }        function updateSelectedItems() {            let selectedItems = [];            let selectedItemsHtml = "<h3>已选择的商品：</h3><ul>"; // 初始化 HTML 代码            $('.check_one:checked').each(function() {                let row = $(this).closest('tr');                let goodname = row.find('td:eq(1)').text(); // 商品名称                let number = row.find('.goods_num').val(); // 商品数量                let price = row.find('.goods_price').text(); // 商品单价                let address = row.find('input.address').val(); // 获取地址                let merchantname = row.find('.merchant_name').text(); // 获取商家名称                selectedItems.push({                    goodname: goodname,                    number: number,                    price: price,                    address: address,                    merchantname: merchantname // 包含商家名称                });                // 将已选择的商品信息添加到 HTML 中                selectedItemsHtml += "<li>" + goodname + " - 数量: " + number + " - 单价: " + price + " - 商家: " + merchantname + "</li>";            });            selectedItemsHtml += "</ul>"; // 结束列表            // 更新显示已选商品的 DIV            $('#selectedItems').html(selectedItemsHtml);        }        // 选中复选框时更新显示        $(document).on('change', '.check_one', function() {            updateSelectedItems(); // 调用功能更新已选商品信息        });        function checkout() {            let selectedItems = [];            let username = "<%=session.getAttribute("upname")%>"; // 获取用户名            let selectedItemsHtml = "<h3>已选择的商品：</h3><ul>"; // 初始化 HTML 代码            $('.check_one:checked').each(function() {                let row = $(this).closest('tr');                let goodname = row.find('td:eq(1)').text(); // 商品名称                let number = row.find('.goods_num').val(); // 商品数量                let price = row.find('.goods_price').text(); // 商品单价                let address = row.find('input.address').val(); // 获取地址                let merchantname = row.find('.merchant_name').text(); // 获取商家名称                selectedItems.push({                    username: username,                    goodname: goodname,                    number: number,                    price: price,                    address: address,                    merchantname: merchantname // 包含商家名称                });                // 将已选择的商品信息添加到 HTML 中                selectedItemsHtml += "<li>" + goodname + " - 数量: " + number + " - 单价: " + price + " - 商家: " + merchantname + "</li>";            });            selectedItemsHtml += "</ul>"; // 结束列表            // 更新显示已选商品的 DIV            $('#selectedItems').html(selectedItemsHtml);            if (selectedItems.length === 0) {                alert("请至少选择一件商品进行结算！");                return;            }            // 计算总金额            let totalCost = selectedItems.reduce((sum, item) => sum + (item.number * parseFloat(item.price)), 0);            // 检查用户余额            $.ajax({                url: "iindent", // 在这里调用下单 Servlet                type: "POST",                data: { items: JSON.stringify(selectedItems), totalCost: totalCost, username: username }, // 增加总金额                success: function(response) {                    // 基于服务器返回的信息处理                    if (response == "余额不足") {                        alert("余额不足，无法完成订单！");                        window.location.reload(); // 刷新页面                    } else {                        alert("订单创建成功！");                        window.location.reload(); // 刷新页面                    }                },                error: function() {                    alert("订单创建失败，请重试");                }            });        }    </script></head><body><div class="main_down">    <div class="container">        <div class="navigation">            <a href="mainFrame.jsp">推荐商品</a>            <a href="allShop.jsp">全部商品</a>            <a href="cart.jsp">购物车</a> <!-- 新增购物车链接 -->            <a href="logout">退出</a> <!-- 退出登录链接 -->            <a href="manageGood.jsp" class="login-button">商家</a> <!-- 新增登录按钮 -->        </div>        <div class="cart_top"><span>购物车</span></div>        <div class="cart_wrap">            <div class="cart-left">                <table class="cart_table" border="1" cellspacing="0" bgcolor="#fffafa" rules="rows">                    <tr class="cart_title">                        <th></th>                        <th>商品</th>                        <th>图片</th>                        <th>单价</th>                        <th>数量</th>                        <th>总价</th>                        <th>地址</th>                        <th>商家名称</th>                        <th>操作</th>                    </tr>                    <%                        String username = (String) session.getAttribute("upname");                        ArrayList<Cart> cartItems = Cart_Use.getCartItems(username);                        for (Cart item : cartItems) {                            String goodImage = null; // 通过商品 ID 获取对应的 Goodlist                            try {                                goodImage = Goodlist_Use.searchImageByName(item.getGoodName());                            } catch (SQLException e) {                                throw new RuntimeException(e);                            }                    %>                    <tr class="cart_item">                        <td><input type="checkbox" class="check_one">&nbsp;</td>                        <td class="goods_name"><%=item.getGoodName()%></td>                        <td>                            <img src="<%= goodImage != null ? goodImage : "" %>" alt="<%= item.getGoodName() %>" style="width: auto; height: 100px;"> <!-- 显示商品图片 -->                        </td>                        <td class="goods_price"><%=item.getPrice()%></td>                        <td>                            <input type="text" value="<%=item.getNumber()%>" class="goods_num">                        </td>                        <td><%=String.format("%.2f", item.getNumber() * Double.parseDouble(item.getPrice()))%></td>                        <td><input type="text" class="address" value="<%=item.getAddress()%>" placeholder="填写地址"></td>                        <td class="merchant_name"><%=item.getmerchantname()%></td>                        <td>                            <button onclick="deleteItem('<%=item.getId()%>')">删除</button>                        </td>                    </tr>                    <%                        }                    %>                </table>            </div>            <div class="selected-items-container">                <div id="selectedItems" style="border: 1px solid #ccc; padding: 10px; height: 600px; overflow-y: scroll;">                    <!-- 用于显示选中的商品信息 -->                </div>                <div class="buttons">                    <button class="gwcbtn" onclick="clearCart()">清空购物车</button>                    <button class="gwcbtn" onclick="checkout()">结算</button>                </div>            </div>        </div>    </div></div></body></html>